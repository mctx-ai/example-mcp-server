# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

---

## What This Is

An **example MCP server** built with `@mctx-ai/mcp-server` framework. Demonstrates all framework capabilities in a single, well-commented reference implementation (`src/index.ts`).

**Purpose:** Serve as learning material and template for developers building MCP servers with this framework.

**Key Features:**
- Four tool patterns (sync string, object return, generators with progress, LLM sampling)
- Two resource patterns (static URI, dynamic URI template)
- Two prompt patterns (single-message, multi-message conversation)
- Structured logging throughout
- Environment variable configuration demo
- Comprehensive test coverage

---

## Architecture

### High-Level Structure

```
src/index.ts        → Server implementation (all features in one file)
  ├─ Tools          → Functions LLM clients can invoke
  ├─ Resources      → Data exposed via URIs
  ├─ Prompts        → Reusable message templates
  └─ Export         → Fetch handler for JSON-RPC 2.0 over HTTP

src/index.test.ts   → Comprehensive tests for all capabilities
dist/index.js       → Bundled output (generated by esbuild)
```

### Framework Pattern

**Registration:** All capabilities (tools, resources, prompts) follow a decorator pattern:
1. Define handler function with specific signature
2. Attach metadata (`.description`, `.input`, `.mimeType`)
3. Register with server via `server.tool()`, `server.resource()`, or `server.prompt()`

**Handler signatures:**
- **ToolHandler:** `(args, ask?) => string | object | Promise<string | object>`
- **GeneratorToolHandler:** `function* (args) { yield progress; return result; }`
- **ResourceHandler:** `(params) => string`
- **PromptHandler:** `(args) => string | conversation(...)`

**Schema system:** The `T` namespace provides type-safe schema builders (`.string()`, `.number()`, `.boolean()`, etc.) with validation constraints.

### Entry Point

`createServer()` initializes an MCP server instance. The returned `server.fetch` property is a Web Standard Fetch API handler compatible with:
- Cloudflare Workers
- Deno Deploy
- Node.js with adapters
- mctx hosting platform

The handler processes JSON-RPC 2.0 requests over HTTP.

---

## Common Development Commands

### Build
```bash
npm run build
```
Bundles `src/index.ts` → `dist/index.js` using esbuild (minified ESM output).

### Development
```bash
npm run dev
```
Runs parallel watch mode:
- `dev:build` — esbuild watch (rebuilds on source changes)
- `dev:server` — mctx-dev hot-reloads server on rebuild

**Test environment variables during dev:**
```bash
GREETING="Howdy" npm run dev
```

### Testing
```bash
# Run all tests
npm test

# Run tests in watch mode
npm test -- --watch

# Run specific test file
npm test src/index.test.ts

# Run tests matching pattern
npm test -- -t "greet"
```

Tests use Vitest with JSON-RPC 2.0 request helpers. Each test creates a `Request` object, calls `server.fetch()`, and validates the JSON-RPC response.

### Linting
```bash
# Check for issues
npm run lint

# Lint specific file
npx eslint src/index.ts
```

Uses ESLint 9 with TypeScript plugin and Prettier integration (via `eslint-config-prettier`).

### Formatting
```bash
# Format all files
npm run format

# Check formatting without modifying
npm run format:check
```

Prettier configuration: `singleQuote: true` (in `.prettierrc`).

---

## Environment Variables

**`GREETING`** — Customizes the greeting message in the `greet` tool.
- **Default:** `"Hello"`
- **Example:** `GREETING="Howdy"` → greet tool returns "Howdy, {name}!"
- **Set in mctx dashboard** when deployed for production configuration

This demonstrates how to read environment variables in MCP servers deployed to mctx.

---

## Testing Patterns

### JSON-RPC Helper Functions

**`createRequest(method, params)`** — Creates a `Request` object with proper JSON-RPC 2.0 structure:
```typescript
{
  jsonrpc: '2.0',
  id: 1,
  method: 'tools/call',
  params: { name: 'greet', arguments: { name: 'Alice' } }
}
```

**`getResponse(response)`** — Parses JSON-RPC response from `Response` object.

### Test Structure

Tests organized by capability type:
- **Tools** — Invoke via `tools/call`, validate `result.content[0].text`
- **Resources** — Read via `resources/read`, validate `result.contents[0].text` and `mimeType`
- **Prompts** — Get via `prompts/get`, validate `result.messages[]` array structure
- **Server Capabilities** — List via `tools/list`, `resources/list`, `prompts/list`

Error handling tests verify `result.isError === true` and error message content.

---

## GitHub Actions Security

**ALL GitHub Actions MUST be SHA-pinned. NO EXCEPTIONS.**

### The Rule

Reference actions by full commit SHA, never by tag or branch name.

**Why this matters:**
- **Tags are mutable** - Can be force-pushed to point to malicious code
- **Supply chain security** - Prevents compromised action maintainers from injecting code into your workflows
- **Reproducibility** - Guarantees exact same action code runs every time
- **Audit trail** - Clear record of exactly which version ran

### Examples

❌ **WRONG - Tag references:**
```yaml
uses: actions/checkout@v4
uses: actions/setup-node@v4
uses: docker/build-push-action@v5
```

✅ **CORRECT - SHA-pinned with version comment:**
```yaml
uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
uses: docker/build-push-action@4f58ea79222b3b9dc2c8bbdd6debcef730109a75 # v5.0.0
```

### Comment Convention

Always include a trailing comment with the version tag for human readability:
- Makes reviews easier (reviewers see version at a glance)
- Simplifies upgrades (know which tag to look for when updating)
- Documents intent (SHA alone is opaque)

**Format:** `uses: owner/repo@<full-sha> # <version-tag>`

### Finding SHAs

```bash
# Get SHA for a specific tag
gh api repos/actions/checkout/git/ref/tags/v4.2.2 --jq '.object.sha'

# Or browse releases on GitHub
# https://github.com/actions/checkout/releases
```

### Enforcement

All workflow files in `.github/workflows/` must comply. PRs with tag-based action references will be rejected.

## Version Bump Process

**Admin-only operation.** Version bumps require branch protection bypass (admin privileges). Only Karl can push these.

### Steps

1. Update `version` in `package.json` on `main` (run `npm install` to sync `package-lock.json`)
2. Commit on `main`: `chore: bump version to X.Y.Z`
3. Cherry-pick that commit onto `release`
4. Push both `main` and `release` branches

### Notes

- No code changes — version bump only
- Requires admin bypass for branch protection on both `main` and `release`
- Always wait for any in-flight deployments to finish before pushing
- **Order matters:** Always commit on `main` first, then cherry-pick to `release` — not the reverse
