function Te(e={}){let r={type:"string"};return e.description!==void 0&&(r.description=e.description),e.enum!==void 0&&(r.enum=e.enum),e.default!==void 0&&(r.default=e.default),e.minLength!==void 0&&(r.minLength=e.minLength),e.maxLength!==void 0&&(r.maxLength=e.maxLength),e.pattern!==void 0&&(r.pattern=e.pattern),e.format!==void 0&&(r.format=e.format),e.required===!0&&(r._required=!0),r}function ve(e={}){let r={type:"number"};return e.description!==void 0&&(r.description=e.description),e.enum!==void 0&&(r.enum=e.enum),e.default!==void 0&&(r.default=e.default),e.min!==void 0&&(r.minimum=e.min),e.max!==void 0&&(r.maximum=e.max),e.required===!0&&(r._required=!0),r}function Pe(e={}){let r={type:"boolean"};return e.description!==void 0&&(r.description=e.description),e.default!==void 0&&(r.default=e.default),e.required===!0&&(r._required=!0),r}function ze(e={}){let r={type:"array"};return e.description!==void 0&&(r.description=e.description),e.default!==void 0&&(r.default=e.default),e.items!==void 0&&(r.items=z(e.items)),e.required===!0&&(r._required=!0),r}function Ce(e={}){let r={type:"object"};if(e.description!==void 0&&(r.description=e.description),e.default!==void 0&&(r.default=e.default),e.properties!==void 0){let{properties:t,required:n}=G(e.properties);r.properties=t,n.length>0&&(r.required=n)}return e.additionalProperties!==void 0&&(typeof e.additionalProperties=="boolean"?r.additionalProperties=e.additionalProperties:r.additionalProperties=z(e.additionalProperties)),e.required===!0&&(r._required=!0),r}function G(e){if(!e||typeof e!="object")return{properties:{},required:[]};let r={},t=[];for(let[n,i]of Object.entries(e))!i||typeof i!="object"||(i._required===!0&&t.push(n),r[n]=z(i));return{properties:r,required:t}}function z(e){if(!e||typeof e!="object")return e;let r={...e};if(delete r._required,r.properties&&typeof r.properties=="object"){let{properties:t,required:n}=G(r.properties);r.properties=t,n.length>0&&(r.required=n)}return r.items&&typeof r.items=="object"&&(r.items=z(r.items)),r.additionalProperties&&typeof r.additionalProperties=="object"&&(r.additionalProperties=z(r.additionalProperties)),r}function j(e){if(!e)return{type:"object",properties:{}};let{properties:r,required:t}=G(e),n={type:"object",properties:r};return t.length>0&&(n.required=t),n}var h={string:Te,number:ve,boolean:Pe,array:ze,object:Ce};function $(e){return!e||typeof e!="string"?!1:/\{[^}]+\}/.test(e)}function Le(e){if(!e||typeof e!="string")return[];let r=e.matchAll(/\{([^}]+)\}/g),t=[];for(let n of r){let i=n[1];if(!/^[a-zA-Z0-9_]+$/.test(i))throw new Error(`Invalid template variable name: "${i}". Must contain only alphanumeric characters and underscores.`);t.push(i)}return t}function W(e,r){if(!e||typeof e!="string"||!r||typeof r!="string")return null;if(!$(e))return e===r?{params:{}}:null;let t=Le(e),n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\\{([^}]+)\\\}/g,"([^/]+)");n=`^${n}$`;let i=new RegExp(n),p=r.match(i);if(!p)return null;let b={};for(let S=0;S<t.length;S++)b[t[S]]=p[S+1];return{params:b}}var T={maxExecutionTime:6e4,maxYields:1e4};function k(e){if(e!==void 0&&(typeof e!="number"||e<=0))throw new Error("createProgress() total must be a positive number if provided");let r=0;return function(){r++;let n={type:"progress",progress:r};return e!==void 0&&(n.total=e),n}}function X(e,r,t){if(!e||typeof e!="object"||!r||!r.type)return w();let n=t||"";return r.type==="ref/prompt-argument"?_e(e,r,n):r.type==="ref/resource"?qe(e,r,n):w()}function _e(e,r,t){let n=r.name;if(!n)return w();let i=e[n];if(!i)return w();if(typeof i.complete=="function")return Q(i.complete,r.argumentName,t);if(i.input&&r.argumentName){let p=i.input[r.argumentName];if(p&&p.enum&&Array.isArray(p.enum))return ee(p.enum,t)}return w()}function qe(e,r,t){let n=r.uri;if(!n)return w();let i=e[n];return i&&typeof i.complete=="function"?Q(i.complete,null,t):w()}function Q(e,r,t){try{let n=e(r,t);if(n instanceof Promise)throw new Error("Async completion handlers are not supported. Use synchronous handlers for fn.complete.");return Array.isArray(n)?ee(n,t):w()}catch(n){return console.error("Completion handler error:",n),w()}}function ee(e,r){if(!Array.isArray(e))return w();let t=r.toLowerCase(),n=e.filter(b=>typeof b!="string"?!1:b.toLowerCase().startsWith(t)),i=n.length>100;return{completion:{values:n.slice(0,100),hasMore:i}}}function w(){return{completion:{values:[],hasMore:!1}}}var I={emergency:0,alert:1,critical:2,error:3,warning:4,notice:5,info:6,debug:7},$e=1e4,C=[],re="debug";function x(e,r){if(!Ie(e,re))return;let t={type:"log",level:e,data:r};return C.push(t),C.length>$e&&C.shift(),t}function Ie(e,r){let t=I[e],n=I[r];return t===void 0||n===void 0?!0:t<=n}function te(e){if(I[e]===void 0)throw new Error(`Invalid log level: "${e}". Must be one of: ${Object.keys(I).join(", ")}`);re=e}function ne(){return[...C]}function oe(){C=[]}var g={debug(e){return x("debug",e)},info(e){return x("info",e)},notice(e){return x("notice",e)},warning(e){return x("warning",e)},error(e){return x("error",e)},critical(e){return x("critical",e)},alert(e){return x("alert",e)},emergency(e){return x("emergency",e)}};var ie=[{regex:/AKIA[0-9A-Z]{16}/g,label:"REDACTED_AWS_KEY"},{regex:/eyJ[a-zA-Z0-9_-]+\.eyJ[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+/g,label:"REDACTED_JWT"},{regex:/(?:mongodb|postgres|mysql|mariadb|mssql|oracle):\/\/[^\s]+/gi,label:"REDACTED_CONNECTION_STRING"},{regex:/Bearer\s+[a-zA-Z0-9_\-.]+/gi,label:"Bearer [REDACTED]"},{regex:/gh[pors]_[a-zA-Z0-9]{33,40}/g,label:"REDACTED_GITHUB_TOKEN"},{regex:/xox[bpas]-[a-zA-Z0-9]+-[a-zA-Z0-9-]+/g,label:"REDACTED_SLACK_TOKEN"},{regex:/-----BEGIN (?:RSA |EC |DSA )?PRIVATE KEY-----[\s\S]*?-----END (?:RSA |EC |DSA )?PRIVATE KEY-----/g,label:"REDACTED_PRIVATE_KEY"},{regex:/AIzaSy[0-9A-Za-z\-_]{21,}/g,label:"REDACTED_GCP_KEY"},{regex:/AccountKey=[a-zA-Z0-9+/=]{40,}/g,label:"REDACTED_AZURE_KEY"},{regex:/(?:api[_-]?key|token|secret|password)\s{0,10}[=:]\s{0,10}['"]?([a-zA-Z0-9_.-]{16,})['"]?/gi,label:e=>e.replace(/(['"]?)[a-zA-Z0-9_.-]{16,}(['"]?)/,"$1[REDACTED]$2")}],Ne=["file","javascript","data","vbscript","about"];function se(e,r=!0){if(!e)return"Unknown error";let t=e.message||String(e);for(let n of ie)typeof n.label=="function"?t=t.replace(n.regex,n.label):t=t.replace(n.regex,`[${n.label}]`);if(!r&&e.stack){let n=e.stack;for(let i of ie)typeof i.label=="function"?n=n.replace(i.regex,i.label):n=n.replace(i.regex,`[${i.label}]`);return n}return t}function ae(e,r=1048576){if(!e)return;let t=typeof e=="string"?e.length:JSON.stringify(e).length;if(t>r)throw new Error(`Request body too large: ${t} bytes (max: ${r} bytes)`)}function ce(e,r=1048576){if(!e)return;let t=typeof e=="string"?e.length:JSON.stringify(e).length;if(t>r)throw new Error(`Response body too large: ${t} bytes (max: ${r} bytes)`)}function ue(e){if(!e||typeof e!="string")return!1;let r=e.match(/^([a-z][a-z0-9+.-]*?):/i);if(!r)return!1;let t=r[1].toLowerCase();return!(!/^[a-z][a-z0-9+.-]*$/.test(t)||t.length>32||Ne.includes(t))}function le(e){if(!e||typeof e!="string")throw new Error("Invalid URI: must be a non-empty string");let r=e;for(let i=0;i<3;i++)try{let p=decodeURIComponent(r);if(p===r)break;r=p}catch{break}if(r.includes("%00")||r.includes("\0"))throw new Error("Path traversal detected: null byte injection is not allowed");if(r.includes("../")||r.includes("../")||r.includes("../"))throw new Error("Path traversal detected: Unicode-encoded ../ sequences are not allowed");if(r.includes("../")||r.includes("..\\"))throw new Error("Path traversal detected: ../ sequences are not allowed");let t=r.toLowerCase();if(t.includes("%2e%2e%2f")||t.includes("%2e%2e/")||t.includes("..%2f")||t.includes("%2e.")||t.includes(".%2e"))throw new Error("Path traversal detected: encoded ../ sequences are not allowed");let n=r.replace(/\\/g,"/");return n=n.replace(/\/+/g,"/"),n}function v(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(t=>v(t));let r={};for(let t in e)t==="__proto__"||t==="constructor"||t==="prototype"||Object.prototype.hasOwnProperty.call(e,t)&&(r[t]=v(e[t]));return r}var L={"Content-Type":"application/json; charset=utf-8","X-Content-Type-Options":"nosniff","Content-Security-Policy":"default-src 'none'","X-Frame-Options":"DENY"};function N(e){let r=new WeakSet;return JSON.stringify(e,(t,n)=>n===void 0||n===null?null:typeof n!="object"?typeof n=="bigint"?n.toString():n:n instanceof Date?n.toISOString():r.has(n)?"[Circular]":(r.add(n),n))}function _(e){let r=!process.env.NODE_ENV||process.env.NODE_ENV==="production";return se(e,r)}function Oe(e){if(!e)return 0;try{let r=Buffer.from(e,"base64").toString("utf-8"),t=parseInt(r,10);return isNaN(t)||t<0?0:t}catch{return 0}}function De(e){return Buffer.from(String(e),"utf-8").toString("base64")}function O(e,r,t=50){let n=Oe(r),p={items:e.slice(n,n+t)};return n+t<e.length&&(p.nextCursor=De(n+t)),p}function M(e={}){let{instructions:r}=e,t=new Map,n=new Map,i=new Map;function p(l,o){if(typeof o!="function")throw new Error(`Tool handler for "${l}" must be a function`);return t.set(l,o),q}function b(l,o){if(typeof o!="function")throw new Error(`Resource handler for "${l}" must be a function`);return n.set(l,o),q}function S(l,o){if(typeof o!="function")throw new Error(`Prompt handler for "${l}" must be a function`);return i.set(l,o),q}function de(l={}){let o=Array.from(t.entries()).map(([u,a])=>({name:u,description:a.description||"",inputSchema:j(a.input)})),{items:c,nextCursor:s}=O(o,l.cursor),f={tools:c};return s&&(f.nextCursor=s),f}async function pe(l,o={}){let{name:c,arguments:s}=l;if(!c)throw new Error("Tool name is required");let f=t.get(c);if(!f)throw new Error(`Tool "${c}" not found`);if(s==null)throw new Error("Tool arguments are required");let u=v(s);try{if(function(P){if(!P||!P.constructor)return!1;let D=P.constructor.name;if(D==="GeneratorFunction"||D==="AsyncGeneratorFunction")return!0;let A=Object.getPrototypeOf(P);return A&&A[Symbol.toStringTag]==="GeneratorFunction"}(f))return await me(f,u,null,o);let m=await f(u,null);return typeof m=="string"?{content:[{type:"text",text:m}]}:{content:[{type:"text",text:N(m)}]}}catch(a){return{content:[{type:"text",text:_(a)}],isError:!0}}}async function me(l,o,c,s){let f=s.progressToken,u=Date.now(),a=0,d=[];try{let y=l(o,c),m=await y.next();for(;!m.done;){if(a++,a>T.maxYields)throw new Error(`Generator exceeded maximum yields (${T.maxYields})`);if(Date.now()-u>T.maxExecutionTime)throw new Error(`Generator exceeded maximum execution time (${T.maxExecutionTime}ms)`);let A=m.value;A&&typeof A=="object"&&A.type==="progress"&&f&&d.push({progressToken:f,...A}),m=await y.next()}let R=m.value;return typeof R=="string"?{content:[{type:"text",text:R}]}:{content:[{type:"text",text:N(R)}]}}catch(y){return{content:[{type:"text",text:_(y)}],isError:!0}}}function ge(l={}){let o=Array.from(n.entries()).filter(([u])=>!$(u)).map(([u,a])=>({uri:u,name:a.name||u,description:a.description||"",mimeType:a.mimeType||"text/plain"})),{items:c,nextCursor:s}=O(o,l.cursor),f={resources:c};return s&&(f.nextCursor=s),f}function ye(l={}){let o=Array.from(n.entries()).filter(([u])=>$(u)).map(([u,a])=>({uriTemplate:u,name:a.name||u,description:a.description||"",mimeType:a.mimeType||"text/plain"})),{items:c,nextCursor:s}=O(o,l.cursor),f={resourceTemplates:c};return s&&(f.nextCursor=s),f}async function he(l){let{uri:o}=l;if(!o)throw new Error("Resource URI is required");if(!ue(o))throw new Error("Disallowed URI scheme: dangerous schemes like file://, javascript:, data: are not allowed");let c=le(o),s=null,f={};if(n.has(c))s=n.get(c);else for(let[u,a]of n.entries()){let d=u.replace(/\\/g,"/").replace(/\/+/g,"/"),y=W(d,c);if(y){s=a,f=y.params||{};break}}if(!s)throw new Error(`Resource "${o}" not found`);try{let a=v(f),d=await s(a,null),y=s.mimeType||"text/plain";if(typeof d=="string")return{contents:[{uri:o,mimeType:y,text:d}]};if(d instanceof Buffer||d instanceof Uint8Array){let R=Buffer.from(d).toString("base64");return{contents:[{uri:o,mimeType:y,blob:R}]}}let m=N(d);return{contents:[{uri:o,mimeType:"application/json",text:m}]}}catch(u){throw new Error(`Failed to read resource "${o}": ${_(u)}`)}}function we(l={}){let o=Array.from(i.entries()).map(([u,a])=>{let d=a.input?Object.entries(a.input).map(([y,m])=>({name:y,description:m.description||"",required:m._required===!0})):[];return{name:u,description:a.description||"",arguments:d}}),{items:c,nextCursor:s}=O(o,l.cursor),f={prompts:c};return s&&(f.nextCursor=s),f}async function Ee(l){let{name:o,arguments:c}=l;if(!o)throw new Error("Prompt name is required");let s=i.get(o);if(!s)throw new Error(`Prompt "${o}" not found`);try{let u=v(c||{}),a=await s(u,null);return typeof a=="string"?{messages:[{role:"user",content:{type:"text",text:a}}]}:Array.isArray(a)?{messages:a}:a&&a.messages?a:{messages:[{role:"user",content:{type:"text",text:N(a)}}]}}catch(f){throw new Error(`Failed to get prompt "${o}": ${_(f)}`)}}function xe(l){let{ref:o,argument:c}=l;if(!o||!o.type)return{completion:{values:[],hasMore:!1}};let s;if(o.type==="ref/prompt-argument")s=Object.fromEntries(i);else if(o.type==="ref/resource")s=Object.fromEntries(n);else return{completion:{values:[],hasMore:!1}};return X(s,o,c?.value)}function be(l){let{level:o}=l;if(!o)throw new Error("Log level is required");return te(o),{}}function Ae(l){let o={};t.size>0&&(o.tools={}),n.size>0&&(o.resources={subscribe:!1,listChanged:!1}),i.size>0&&(o.prompts={}),o.logging={};let c={protocolVersion:"2024-11-05",capabilities:o,serverInfo:{name:"@mctx-ai/mcp-server",version:"0.3.0"}};return r&&(c.instructions=r),c}async function Se(l){let{method:o,params:c,_meta:s}=l;switch(o){case"initialize":return Ae(c);case"initialized":return null;case"ping":return{};case"tools/list":return de(c);case"tools/call":return await pe(c,s);case"resources/list":return ge(c);case"resources/read":return await he(c);case"resources/templates/list":return ye(c);case"prompts/list":return we(c);case"prompts/get":return await Ee(c);case"notifications/cancelled":return null;case"completion/complete":return xe(c);case"logging/setLevel":return be(c);default:{let f=new Error("Method not found");throw f.code=-32601,f}}}async function Re(l,o,c){if(l.method!=="POST")return new Response(JSON.stringify({jsonrpc:"2.0",error:{code:-32600,message:"Invalid Request - Only POST method is supported"},id:null}),{status:405,headers:L});let s,f;try{f=await l.text(),ae(f),s=JSON.parse(f)}catch{return new Response(JSON.stringify({jsonrpc:"2.0",error:{code:-32700,message:"Parse error - Invalid JSON"},id:null}),{status:400,headers:L})}if(!s.method||typeof s.method!="string")return new Response(JSON.stringify({jsonrpc:"2.0",error:{code:-32600,message:"Invalid Request - Missing or invalid method"},id:s.id||null}),{status:400,headers:L});try{let u=await Se(s);if(ne(),oe(),!("id"in s))return new Response(null,{status:204});let a={jsonrpc:"2.0",id:s.id,result:u};return ce(a),new Response(JSON.stringify(a),{status:200,headers:L})}catch(u){let d=u&&typeof u=="object"&&"code"in u?u:{code:-32603,message:_(u instanceof Error?u:new Error(String(u)))};return new Response(JSON.stringify({jsonrpc:"2.0",id:s.id||null,error:d}),{status:200,headers:L})}}let q={tool:p,resource:b,prompt:S,fetch:Re};return q}function H(e){if(typeof e!="function")throw new Error("conversation() requires a builder function");let r=fe("user"),t=fe("assistant"),n=e({user:r,ai:t});if(!Array.isArray(n))throw new Error("Builder function must return an array of messages");return{messages:n}}function fe(e){return{say(r){if(typeof r!="string")throw new Error(`${e}.say() requires a string argument`);return{role:e,content:{type:"text",text:r}}},attach(r,t){if(typeof r!="string")throw new Error(`${e}.attach() requires base64 data as first argument`);if(t==null)throw new Error(`${e}.attach() requires mimeType as second argument (e.g., "image/png")`);if(typeof t!="string")throw new Error(`${e}.attach() requires mimeType as second argument (e.g., "image/png")`);if(!/^[a-zA-Z]+\/[a-zA-Z0-9\-+.]+$/.test(t))throw new Error(`Invalid MIME type: "${t}". Expected format: type/subtype (e.g., "image/png")`);return{role:e,content:{type:"image",data:r,mimeType:t}}},embed(r){if(typeof r!="string")throw new Error(`${e}.embed() requires a URI string`);return{role:e,content:{type:"resource",resource:{uri:r,text:"[embedded]"}}}}}}var E=M({instructions:"An example MCP server showcasing all framework features. Use 'greet' for a hello (customizable via GREETING env var), 'calculate' for math, 'analyze' for progress-tracked analysis, and 'smart-answer' for LLM-assisted Q&A. Resources include docs://readme and user://{userId}. Prompts include 'code-review' and 'debug'."}),U=e=>{let{name:r}=e,t=process.env.GREETING||"Hello",n=r.trim();return g.info(`Greeting ${n} with: ${t}`),`${t}, ${n}!`};U.description='Greets a person by name using the GREETING environment variable (default: "Hello")';U.input={name:h.string({required:!0,description:"Name to greet",minLength:1,maxLength:100})};E.tool("greet",U);var B=e=>{let{operation:r,a:t,b:n}=e;if(r==="divide"&&n===0)throw g.error({error:"Division by zero attempted",operation:r,a:t,b:n}),new Error("Division by zero");let i={add:t+n,subtract:t-n,multiply:t*n,divide:t/n};return g.debug({operation:r,a:t,b:n,result:i[r]}),{operation:r,a:t,b:n,result:i[r]}};B.description="Performs arithmetic operations";B.input={operation:h.string({required:!0,enum:["add","subtract","multiply","divide"],description:"Arithmetic operation to perform"}),a:h.number({required:!0,description:"First operand"}),b:h.number({required:!0,description:"Second operand"})};E.tool("calculate",B);var Z=function*(e){let{topic:r}=e;g.info(`Starting analysis of topic: ${r}`);let t=k(3);yield t(),g.debug("Phase 1: Research complete"),yield t(),g.debug("Phase 2: Analysis complete"),yield t(),g.notice("Phase 3: Synthesis complete");let n=`Analysis of "${r}" complete. Found 42 insights across 7 categories.`;return g.info({topic:r,result:"success",insights:42,categories:7}),n};Z.description="Analyzes a topic with progress updates";Z.input={topic:h.string({required:!0,description:"Topic to analyze",minLength:3,maxLength:200})};E.tool("analyze",Z);var J=async(e,r)=>{let{question:t}=e;if(g.info(`Processing question: ${t}`),!r)return g.warning("Sampling not available, providing basic answer"),`Answer to: ${t}`;g.debug("Sampling enabled, requesting clarification from LLM");let n=await r("What additional context would help me answer this better?");return g.debug({clarification:n}),`Question: ${t}
Context: ${n}
Answer: With the additional context, here is a comprehensive answer.`};J.description="Answers questions, optionally asking the LLM for clarification";J.input={question:h.string({required:!0,description:"Question to answer",minLength:5})};E.tool("smart-answer",J);var F=()=>"Welcome to the example MCP server built with @mctx-ai/mcp-server. This server demonstrates tools, resources, prompts, progress tracking, and sampling.";F.description="Server documentation";F.mimeType="text/plain";E.resource("docs://readme",F);var K=e=>{let{userId:r}=e;return JSON.stringify({id:r,name:`User ${r}`,joined:"2024-01-01",plan:"pro"})};K.description="User profile by ID";K.mimeType="application/json";E.resource("user://{userId}",K);var Y=e=>{let{code:r,language:t}=e;return`Please review this ${t||"code"} for bugs, security issues, and improvements:

\`\`\`${t||""}
${r}
\`\`\``};Y.description="Code review prompt";Y.input={code:h.string({required:!0,description:"Code to review"}),language:h.string({description:"Programming language"})};E.prompt("code-review",Y);var V=e=>{let{error:r,context:t}=e;return H(({user:n,ai:i})=>[n.say(`I'm seeing this error: ${r}`),...t?[n.say(`Context:
${t}`)]:[],i.say("I will analyze the error and provide step-by-step debugging guidance.")])};V.description="Debug assistance prompt with structured dialogue";V.input={error:h.string({required:!0,description:"Error message or description",minLength:1}),context:h.string({description:"Additional context, stack trace, or logs",maxLength:5e3})};E.prompt("debug",V);var ir={fetch:E.fetch};export{ir as default};
